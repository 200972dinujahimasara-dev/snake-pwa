<!DOCTYPE html>
<html lang="en">
<head>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Snake Game â€“ Ultimate Edition</title>
    <style>
        :root{--green:#39ff14;--blue:#00ffff;--red:#ff073a}
        body{margin:0;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;color:var(--green);font-family:Consolas,monospace;overflow:hidden}
        canvas{border:3px solid var(--green);box-shadow:0 0 15px var(--green);background:#000}
        button,select{margin:4px;padding:8px 14px;background:transparent;color:var(--blue);border:2px solid var(--blue);cursor:pointer;font-family:inherit}
        #info{display:flex;gap:12px;margin-bottom:8px}
        #powerLabel{margin:6px;font-size:14px; color: #fff}
        #game-over{display:none;position:absolute;background:rgba(0,0,0,0.9);padding:20px;border:2px solid var(--red);color:var(--red);text-align:center;z-index:10}
        #shop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);justify-content:center;align-items:center;z-index:20}
        #shop div{border:2px solid var(--green);padding:20px;background:#000;max-width:80%}
    </style>
</head>
<body>

<div id="info">
    <div id="score">Score: 0</div>
    <div id="coins">Coins: 0</div>
    <select id="difficulty" onchange="restart()">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
    </select>
</div>

<div id="powerLabel">Shield: OFF | CoinBoost: OFF | Revive: OFF | Magnet: OFF</div>
<canvas id="game" width="400" height="400"></canvas>

<div>
    <button onclick="pause()">Pause</button>
    <button onclick="openShop()">Shop</button>
</div>

<div id="game-over">
    <h2>Game Over</h2>
    <p id="final"></p>
    <button onclick="restart()">Play Again</button>
</div>

<div id="shop">
    <div>
        <h3>NEON SHOP</h3>
        <p>Coins: <span id="shopCoins"></span></p>
        <button onclick="buyItem('blue',50)">Blue Skin (50)</button>
        <button onclick="buyItem('red',100)">Red Skin (100)</button><br>
        <button onclick="buyItem('shieldPlus',150)">Shield+ (150)</button>
        <button onclick="buyItem('coinBoost',200)">Coin Boost (200)</button><br>
        <button onclick="buyItem('revive',250)">Revive Heart (250)</button>
        <button onclick="buyItem('magnet',300)">Food Magnet (300)</button><br><br>
        <button onclick="closeShop()" style="color:var(--red); border-color:var(--red)">Close</button>
    </div>
</div>

<script>
const c = document.getElementById('game'), x = c.getContext('2d');
const g = 20, t = 20;
let snake=[], animSnake=[], food, dx=1, dy=0, run=true, score=0;
let coins = parseInt(localStorage.getItem('coins')||'0');
let skin='default', owned=JSON.parse(localStorage.getItem('skins')||'["default"]');
let walls=[], boss=null, bossActive=false;
let coinBoost=false, revive=false, magnet=false, shieldTime=0;
let difficulty='normal', interval, lastTime=0;

function save(){
    localStorage.setItem('coins', coins);
    localStorage.setItem('skins', JSON.stringify(owned));
}

function setDifficulty(){
    difficulty = document.getElementById('difficulty').value;
    walls = [];
    let count = difficulty==='easy'?0:difficulty==='normal'?6:12;
    for(let i=0;i<count;i++) walls.push({x:rand(), y:rand()});
    
    // Update speed based on difficulty
    let fps = difficulty==='easy' ? 10 : difficulty==='normal' ? 15 : 22;
    interval = 1000/fps;
}

function rand(){ return Math.floor(Math.random()*t); }

function restart(){
    snake = [{x:10,y:10}, {x:9,y:10}, {x:8,y:10}];
    animSnake = JSON.parse(JSON.stringify(snake));
    food = {x:rand(),y:rand()};
    dx = 1; dy = 0; score = 0; shieldTime = 0;
    bossActive = false; boss = null;
    coinBoost = revive = magnet = false;
    setDifficulty();
    run = true;
    document.getElementById('game-over').style.display='none';
    lastTime = performance.now();
}

function update(){
    if(!run) return;

    // Spawn Boss
    if(!bossActive && score >= 200){
        bossActive = true;
        boss = {x:rand(), y:rand(), dx:1, dy:0};
    }

    let h = {x: snake[0].x + dx, y: snake[0].y + dy};

    // Boundary Check
    if(h.x < 0 || h.y < 0 || h.x >= t || h.y >= t) return end();

    // Boss Movement
    if(bossActive){
        if(Math.random() < 0.2){
            const dirs = [[1,0],[-1,0],[0,1],[0,-1]];
            let d = dirs[Math.floor(Math.random()*4)];
            boss.dx=d[0]; boss.dy=d[1];
        }
        boss.x += boss.dx; boss.y += boss.dy;
        if(boss.x < 0) { boss.x = 0; boss.dx = 1; }
        if(boss.y < 0) { boss.y = 0; boss.dy = 1; }
        if(boss.x >= t) { boss.x = t-1; boss.dx = -1; }
        if(boss.y >= t) { boss.y = t-1; boss.dy = -1; }
        if(h.x===boss.x && h.y===boss.y) return end();
    }

    // Collision Check (Self & Walls)
    if(snake.some(s => s.x===h.x && s.y===h.y)) return end();
    if(walls.some(w => w.x===h.x && w.y===h.y) && shieldTime<=0) return end();

    snake.unshift(h);
    animSnake.unshift({...h});

    // Food Magnet & Direct Check
    let dist = Math.hypot(food.x - h.x, food.y - h.y);
    if(dist === 0 || (magnet && dist < 2)){
        score+=10;
        coins+=coinBoost?2:1;
        save();
        food={x:rand(),y:rand()};
        // Don't pop - snake grows
    } else {
        snake.pop();
        animSnake.pop();
    }

    if(shieldTime>0) shieldTime--;

    // Update UI
    document.getElementById('score').innerText='Score: '+score;
    document.getElementById('coins').innerText='Coins: '+coins;
    document.getElementById('powerLabel').innerText=
        `Shield: ${shieldTime>0?'ON':'OFF'} | CoinBoost: ${coinBoost?'ON':'OFF'} | Revive: ${revive?'READY':'OFF'} | Magnet: ${magnet?'ON':'OFF'}`;
}

function draw(){
    x.fillStyle='#000'; x.fillRect(0,0,c.width,c.height);

    // Smooth Animation Interpolation
    animSnake.forEach((s,i)=>{
        if(!snake[i]) return;
        s.x += (snake[i].x - s.x)*0.3;
        s.y += (snake[i].y - s.y)*0.3;
    });

    let headColor = skin==='blue'?'#00f':skin==='red'?'#f00':'#0ff';
    let bodyColor = skin==='blue'?'#55f':skin==='red'?'#f55':'#0f0';

    animSnake.forEach((s,i)=>{
        x.fillStyle=i===0?headColor:bodyColor;
        if(i===0 && shieldTime>0){
            x.strokeStyle='#fff'; 
            x.lineWidth = 2;
            x.strokeRect(s.x*g,s.y*g,g-2,g-2);
        }
        x.fillRect(s.x*g,s.y*g,g-2,g-2);
    });

    // Food (Pulse Effect)
    let pulse = Math.sin(Date.now()/100) * 3;
    x.fillStyle='red';
    x.fillRect(food.x*g + pulse/2, food.y*g + pulse/2, (g-2) - pulse, (g-2) - pulse);

    // Boss
    if(bossActive){
        x.fillStyle='#ff00ff';
        x.shadowBlur=15; x.shadowColor='#ff00ff';
        x.fillRect(boss.x*g,boss.y*g,g,g);
        x.shadowBlur=0;
    }

    // Walls
    x.fillStyle='#555';
    walls.forEach(w=>x.fillRect(w.x*g,w.y*g,g-2,g-2));
}

function end(){
    if(revive){
        revive=false; 
        shieldTime = 60; // Give brief invincibility on revive
        return; 
    }
    run=false;
    document.getElementById('final').innerText='Score: '+score;
    document.getElementById('game-over').style.display='block';
}

window.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft' && dx===0){ dx=-1; dy=0; }
    if(e.key==='ArrowRight' && dx===0){ dx=1; dy=0; }
    if(e.key==='ArrowUp' && dy===0){ dx=0; dy=-1; }
    if(e.key==='ArrowDown' && dy===0){ dx=0; dy=1; }
});

function pause(){ run=!run; }

function openShop(){ run=false; document.getElementById('shopCoins').innerText=coins; document.getElementById('shop').style.display='flex'; }
function closeShop(){ run=true; document.getElementById('shop').style.display='none'; }

function buyItem(item,cost){
    if(coins<cost){ alert("Not enough coins!"); return; }
    if(item==='shieldPlus') shieldTime+=300;
    else if(item==='coinBoost') coinBoost=true;
    else if(item==='revive') revive=true;
    else if(item==='magnet') magnet=true;
    else if(item==='blue'||item==='red'){
        skin=item;
        if(!owned.includes(item)) owned.push(item);
    }
    coins-=cost;
    save();
    document.getElementById('shopCoins').innerText=coins;
}

function loop(ts){
    requestAnimationFrame(loop);
    const delta = ts - lastTime;
    if(delta > interval){
        lastTime = ts - (delta % interval);
        update();
    }
    draw();
}

restart();
requestAnimationFrame(loop);
</script>
</body>
</html>